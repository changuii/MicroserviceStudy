# 4.6 공통 데이터를 통한 통신 

다양한 구현과도 관련있는 통신 방식은 공통 데이터를 통한 통신이다.  
이 패턴은 하나의 마이크로서비스가 데이터를 정의한 위치에 넣고 다른 마이크로서비스가 그 데이터를 이용할 때 사용된다.  

하나의 마이크로서비스가 특정 위치에 파일을 떨구고 나중에 다른 마이크로서비스가 해당 파일을 집어 들어 작업을 수행하는 것처럼 간단할 것이다.  
이러한 통합 방식은 기본적으로 비동기식이다.  

신제품 수입자는 다운스트림의 재고 및 카탈로그 마이크로서비스가 읽는 파일을 생성한다.  

이 패턴은 어떤 면에서 가장 흔한 일반적인 프로세스 간 통신 패턴이지만, 프로세스 간 통신이 너무 간접적이어서 눈에 잘 띄지 않는 경우가 많기 떄문에 통신 패턴으로 인식하지 못하는 경우가 종종 있다.  

## 4.6.1 구현

이 패턴을 구현하려면 데이터에 대한 일종의 영구 저장소가 필요하며, 대개는 파일 시스템으로 충분하다.  
필자는 주기적으로 파일 시스템을 스캔해 새 파일의 존재를 확인하고 그에 따라 적절히 반응하는 많은 시스템을 구축했다.  

물론 일종의 강력한 분산 메모리 저장소를 사용할 수도 있다.  
이러한 데이터와 작업하는 다운스트림 마이크로서비스는 새 데이터가 가용하다는 사실을 인식하는 매커니즘이 필요하다.  
예를 들어 폴링은 이 문제에 대한 가장 일반적인 해결책이다.  

이 패턴의 두 가지 일반적인 예는 데이터 레이크와 데이터 웨어하우스다. 두 경우 모두 일반적으로 대량의 데이터를 처리하는 데 도움이 되도록 설계된 솔루션이지만, 결합과 관련해서는 분명 거리가 멀다.  

데이터 레이크를 사용하면 소스는 자신이 적합하다고 생각하는 형식으로 원시 데이터를 업로드하고, 이 원시 데이터의 다운스트림 소비자는 이 정보를 처리하는 방법을 알고 있어야 한다.  
데이터 웨어하우스에서 웨어하우스 자체는 구조화된 데이터 저장소다.  
즉, 구조가 하위호환이 불가능한 방식으로 변경되면 생산자가 업데이트돼야한다.  

데이터 웨어하수으ㅘ 데이터 레이크 모두 정보의 흐름은 한 방향이라고 가정한다.  
한 마이크로서비스는 공통 데이터 저장소에서 데이터를 게시하고, 다운스트림 소비자는 데이터를 읽고 적절한 작업을 수행한다.  
이 단방향 흐름에서 정보의 흐름은 더 쉽게 추론할 수 있다.  

더욱 문제가 되는 구현 방식은 여러 마이크로서비스가 동일한 데이터 저장소를 읽고 쓰는 공유 데이터베이스를 사용하는 것이다.  


## 4.6.2 장점  

이 패턴은 일반적으로 알려진 기술을 사용해 매우 간단하게 구현할 수 있다.  
따라서 파일이나 데이터베이스를 대상으로 읽거나 쓴다면 이 패턴이 유용하다.  
널리 보급되고 잘 알려진 기술을 사용하면, 구형 메인프레임 애플리케이션이나 맞춤형 상용(COTS) 소프트웨어 제품과 같은 다양한 유형의 시스템들을 상호 운용할 수 있다.  
또한 이 방법은 데이터양에서도 큰 문제가 되지 않으므로, 한 번에 많은 데이터를 전송한다면 이 패턴이 효과적이다.  


## 4.6.3 단점

다운스트림의 소비자 마이크로서비스는 일반적으로 일종의 폴링 매커니즘이나 주기적으로 트리거되는 정기 작업을 통해 처리할 신규 데이터가 있음을 인식한다.  
이는 곧 매커니즘이 대기 시간이 짧은 상황에서는 유용하지 못할 수 있다는 의미다.  

물론 이 패턴은 다운스트림 마이크로서비스에 새 데이터가 사용가능하다는 사실을 알리는 다른 종류의 호출과 결합할 수 있다.  
에를 들어 공유 파일 시스템에 파일을 작성하고 나서 관심 있는 마이크로서비스에 호출을 보내 원하는 신규 데이터가 있음을 알릴 수 있다.  
이렇게 하면 게시되는 데이터와 처리되는 데이터 사이의 차이가 줄어든다.  

하지만 일반적으로 아주 많은 양의 데이터에 대해 이 패턴을 사용하면 요구 사항 목록에서 짧은 지연 시간이 우선순위가 높을 가능성은 적다.  
더 많은 양의 데이터를 전송하고 '실시간'으로 더 많이 처리하는 데 관심이 있다면 카프카와 같은 스트리밍 기술이 더 적합하다.  

공통 데이터 저장소가 잠재적으로 결합의 원천이 된다는 것은 또 다른 큰 단점이자 명백한 사실이다.  
해당 데이터 저장소의 구조가 어떤 식으로든 변경되면 마이크로서비스 간 통신이 중단될 수 있다.  

통신의 견고성은 기본 데이터 저장소의 견고성에 따라 결정된다.  
엄밀히 말해 단점은 아니지만 알아둬야 할 특성이다.  
만약 파일 시스템에 파일을 드롭하는 경우라면 파일 시스템 자체가 특이한 방식으로 실패하지 않도록 하는 것이 좋다.  

## 4.6.4 적용 대상  

이 패턴이 정말로 빛을 발하는 순간은 사용 가능한 기술에 제약이 있는 프로세스 사이에서 상호 운용성을 활성화할 때다.  
기존 시스템이 마이크로서비스의 gRPC 인터페이스와 통신하거나 카프카 토픽을 구독하게 만들면 마이크로서비스의 관점에서 더 편리할 수 있지만, 소비자의 관점에서는 그렇지 않다.  

구형 시스템은 지원 가능한 기술에 제한이 있으며 변경 비용이 많이 든다.  
반면에 오래된 메인프레임 시스템이라도 파일에서 데이터를 읽는 것은 가능하다.  

물론 이것은 널리 지원되는 데이터 저장소 기술을 사용하는지에 달려있다.  
레디스 캐시 등을 사용하면 이 패턴을 구현할 수 있지만, 기존 메인프레임 시스템이 레디스와 통신할 수 있을까?  

대용량 데이터를 공유할 수 있다는 점도 이 패턴의 큰 장점이다.  
수 기가바이트 파일을 파일 시스템으로 보내거나 데이터베이스에 수백만 개의 행(row)을 로드해야 한다면 이 패턴이 적합하다.  






